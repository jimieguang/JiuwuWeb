<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>私聊</title>
    <link rel="shortcut icon" href="../../../static/default/favicon.ico"/>
    <link rel="stylesheet" href="../../../static/default/css/base.css">
    <link rel="stylesheet" href="../../../static/default/css/common.css">
    <link rel="stylesheet" href="../../../static/default/css/chat.css">
    
    <script src="../../../static/default/jquery/dist/jquery.js"></script>
</head>
<body>
    <div class="logo"><a href="/"></a></div>
    <div class="object">{{ Black.name }}</div>
    <div class="w">
        {% for message in messages %}
            {% if message.uid_from == Alice.id %}
                <div class="self">
                    <div class="time">{{message.messagedate}}</div>
                    <div class="hp"><img src="../../../static/upload/{{ Alice.avatar}}" alt=""></div>
                    <div class="content">
                        <div class="txt">{{ message.content }}</div>
                        <!-- <div class="triangle"></div> -->
                    </div>
                </div>
            {% else %}
                <div class="other">
                    <div class="time">{{message.messagedate}}</div>
                    <div class="hp"><img src="../../../static/upload/{{ Black.avatar}}" ></div>
                    <div class="content">
                        <div class="txt">{{ message.content }}</div>
                        <!-- <div class="triangle"></div> -->
                    </div>
                </div>
            {% endif %}
        {% endfor %}
        <a class="lab" href="#lab"></a>
        <div id="lab"></div>
    </div>
    <form class="text" action="./" method="post">
        <textarea name="content" id="my_content" cols="30" rows="3" required="required"></textarea>
        <input class="send_btn"  value="发送"></input>
    </form>
    <!-- <form class="post" action="./" method="post">
        安全性参数
        {% csrf_token %}
        <input type="text" name="refresh" value="refresh">
        <input type="text" name="pastdate" value="{{ pastdate | date:"Y-m-d H:i:s" }}">
        <input type="submit" id="post">
    </form> -->
</body>

<script>
    // 直达底部
    var lable = document.querySelector('.lab');
    lable.click();

    // 获取当前时间
    function addZero(s) {
        return s < 10 ? ('0' + s) : s;
    }
    function getNowTime() {
        var date = new Date();
        var year = date.getFullYear();  
        var month = date.getMonth() + 1;
        var day = date.getDate();
        var hour = date.getHours();
        var minute = date.getMinutes();
        var second = date.getSeconds();
        var time = year + '年' + month + '月' + addZero(day) + '日 ' + addZero(hour) + ':' + addZero(minute) ;
        return time;
    }

    //添加新消息至页面
    var w = document.querySelector('.w');
    function add_new_msg(Content,Time,Owner,SRC){//内容、时间、归属、头像
        var owner = document.createElement('div');
        var time = document.createElement('div');
        var hp = document.createElement('div');
        var content = document.createElement('div');
        var txt = document.createElement('div');
        var img = document.createElement('img');
        w.appendChild(owner);
        owner.appendChild(time);
        owner.appendChild(hp);
        owner.appendChild(content);
        content.appendChild(txt);
        hp.appendChild(img);
        owner.className=Owner;
        time.className='time';
        hp.className='hp';
        img.setAttribute("src",SRC);
        content.className='content';
        time.innerHTML=(Time);
        txt.className='txt';
        txt.innerHTML=(Content);
    }

    //点击按钮发送消息
    var send_btn=document.querySelector('.send_btn');
    var my_content=document.querySelector('#my_content');
    send_btn.addEventListener('click',function(){
        $.ajax({
            type: "POST",         //获取方式
            url: "",    //数据读取地址(默认当前页面)  
            data:{"csrfmiddlewaretoken": "{{csrf_token}}","content":my_content.value} ,
            dataType:"json",    
            success: function(msg){
                //alert(msg);
            },
            error: function(msg){
                //alert("发送消息失败，请检查网络连接情况！");
            }
        });
        //删除定位标签
        for(let i=0;i<2;i++){
            w.removeChild(w.children[w.children.length-1]);
        }
        add_new_msg(my_content.value,getNowTime(),'self',"../../../static/upload/{{ Alice.avatar}}");
        //加上定位标签
        var a=document.createElement('a');
        var lab = document.createElement('div');
        w.appendChild(a);
        w.appendChild(lab);
        a.className='lab';
        a.setAttribute("href","#lab");
        lab.setAttribute("id","lab");

        lable.click();
        my_content.value='';
    })

    //获取数据
    var past_date = "{{ pastdate }}";
    function get_msg(){
        $.ajax({
            type: "POST",         //获取方式
            url: "",    //数据读取地址(默认当前页面)  
            data:{"csrfmiddlewaretoken": "{{csrf_token}}","refresh": "true","pastdate":past_date} ,
            dataType:"json",    
            success: function(msg){
                var length = msg.length;
                if (length !=0){
                    //删
                    for(let i=0;i<2;i++){
                        w.removeChild(w.children[w.children.length-1]);
                    }
                    for(let i=0;i<length;i++){
                        add_new_msg(msg.content[i],msg.messagedate[i],'other',"../../../static/upload/{{ Black.avatar}}" );
                    }
                    past_date = msg.pastdate;
                    //加
                    var a=document.createElement('a');
                    var lab = document.createElement('div');
                    w.appendChild(a);
                    w.appendChild(lab);
                    a.className='lab';
                    a.setAttribute("href","#lab");

                    lab.setAttribute("id","lab");
                    lable.click();
                }
            },
            error: function(msg){
                alert("同步消息失败，请检查网络连接情况！");
            }
        });
    }
    // 计时器
    var timer=setInterval(function(){
        get_msg();
    },5000)
    //clearInterval(timer);
</script>
</html>